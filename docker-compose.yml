services:
  fastapi:
    build:
      context: .
    expose:
      - "8000"
    env_file: .env
    restart: unless-stopped
    depends_on:
      - postgres
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./src/:/app/src/

    command: ["/app/.venv/bin/python", "main.py"]
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          memory: 128M

  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      # - "443:443"
    env_file:
      - .env
    volumes:
      - ./nginx/templates:/etc/nginx/templates
      # - ./data/certbot/conf:/etc/letsencrypt
      # - ./data/certbot/www:/var/www/certbot
    depends_on:
      - fastapi
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 64M
        reservations:
          memory: 32M

  # certbot:
  #   image: certbot/certbot
  #   restart: unless-stopped
  #   volumes:
  #     - ./data/certbot/conf:/etc/letsencrypt
  #     - ./data/certbot/www:/var/www/certbot
  #   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  postgres:
    container_name: postgres
    image: postgres:16
    ports:
      - "5439:5432"
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
    restart: unless-stopped
    volumes:
      - postgres-volume:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          memory: 128M

  redis:
    restart: unless-stopped
    image: redis:7
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 64M
        reservations:
          memory: 32M

  celery-worker:
    restart: unless-stopped
    build:
      context: .
    command: watchmedo auto-restart --directory=./ --pattern=*.py --recursive -- celery -A src.celery.celery_app worker  --loglevel=debug
    env_file:
      - .env
    depends_on:
      - redis
    volumes:
      - ./src/:/app/src/
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 192M
        reservations:
          memory: 64M

  celery-beat:
    container_name: celery-beat
    restart: unless-stopped
    build:
      context: .
    command: watchmedo auto-restart --directory=./ --pattern=*.py --recursive -- celery -A src.celery.celery_app beat -s /tmp/celerybeat-schedule --loglevel=debug
    volumes:
      - celerybeat-schedule:/tmp
      - ./src/:/app/src/
    env_file:
      - .env
    depends_on:
      - redis

volumes:
  postgres-volume:
  redis-data:
  celerybeat-schedule:
